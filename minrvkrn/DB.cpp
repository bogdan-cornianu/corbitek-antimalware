#include "StdAfx.h"
#include "DB.h"
#include <mysql++.h>
#include <atlstr.h>
#include <atlconv.h>

using namespace std;

int con_ok = 0;

DB::DB(void)
{
}

mysqlpp::Connection DB::Connect(const char* url, const char* username, const char* password)
{
	mysqlpp::Connection con(false);
	
	if (!con.connect("infinity", url, username, password)) {
		//log error connecting to DB
		con_ok = 0;
		return con.error();
	}
	else 
		{
			con_ok = 1;
			return con;
	}
}

const char* DB::Disconnect(void)
{
	if(con_ok == 1)
		connection.disconnect();
	return connection.error();
}

wstring DB::ExecuteQuery(wstring querydb)
{
	string tempstr(CW2A(querydb.c_str()));

if (connection != NULL) 
{
	try
	{
		mysqlpp::Query query = this->connection.query();
		query << tempstr;

		if (mysqlpp::StoreQueryResult res = query.store()) {
			size_t i = res.num_rows();
			if(i > 0) {
				return _T("infected");
			}
		}
		else return _T("");
	} catch (...) {
		return _T("");
	}
}
else
	::MessageBoxExW(NULL,_T("Null DB Connection!"),_T("Antivirus Project"),MB_ICONERROR,0);
	
return _T("");
}

DB::~DB(void)
{
}
